<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Socket.io example</title>
    </head>
    <body>
        <div class="container">
            <div class="MasterNode">
                <h1> MASTER NODE</h1>
                <div class="MasterNodeRun" id="MNRun">
                    
                </div>
                <h1> DEAD MASTER NODEs</h1>
                <div class="MasterNodeDown" id="MNDown">

                </div>
            </div>
            <div class="SlaveNode">
                <h1> WORK SLAVE NODEs</h1>
                <div class="SlaveNodeRun" id="SNRun">
                    
                </div>
                <h1> DEAD SLAVE NODEs</h1>
                <div class="SlaveNodeDown" id="SNDown">

                </div>
            </div>
        </div>
    </body>
</html>

<script>
var socket = new WebSocket("ws://localhost:7000");
const CNT = "_CNT"
const VL = "_VL"
const B_Kill_Node = "BKN_"
const B_Change_Master = "BCM_"

function KillProc(pid){
    let json = {
        "action": "killNode",
        "node": pid
    }
    socket.send(JSON.stringify(json));
    return true
}

socket.onmessage = function(event) {
    var incomingMessage = event.data;
    showMessage(incomingMessage);
};

function showMessage(message) {
    try{
        let jsonMessage = JSON.parse(message)
        if(jsonMessage.status == "Create")
            CreateNode(jsonMessage)
            
        if(jsonMessage.type == "Slave" && jsonMessage.status == "ActionComplite")
            ActionCompileNode(jsonMessage)
        
        if(jsonMessage.type == "Master" && jsonMessage.status == "BecameSlave")
            BecameSlave(jsonMessage)

        if(jsonMessage.status == "NodeCrash")
            CrashNode(jsonMessage)
        
        if(jsonMessage.status == "Change")
            ChangeStatusNode(jsonMessage)
        
        if(jsonMessage.type == "init")
            InitNode(jsonMessage)

        //console.log(jsonMessage)
    }
    catch(e){
        console.log("Message is not JSON! " + message + " " + e)
    }
}
function CreateNode(node, dead = false){
    let type
    let live
    type = (node.type == "Master") ? "MN" : "SN"
    live = dead ? "Down" : "Run"

    let div = selfCreateElement("div", {id : node.Node})
    
    let spanNm = selfCreateElement("span", {innerText : node.Node})
    let spanAv = selfCreateElement("span", {innerText : (node.Processed ? node.Processed : "0") , id:node.Node + CNT})
    let spanVl = selfCreateElement("span", {innerText: node.ActionValue,  id:node.Node + VL})
    let kill = selfCreateElement("button", {innerText: "KILL NODE",  id: B_Kill_Node + node.Node, onclick:"killClick(event)"})
    let SetMaster = selfCreateElement("button", {innerText: "SET MASTER",  id: B_Change_Master + node.Node, onclick:"SetMasterClick(event)", disabled: (node.type =="Master")?true:false})
    
    div.appendChild(kill)
    div.appendChild(SetMaster)
    div.appendChild(spanNm)
    div.appendChild(spanAv)
    div.appendChild(spanVl)
    
    
    document.getElementById(type + live).appendChild(div)

}
function killClick(event){
    KillProc(returnINT(event.target.id))
}
function SetMasterClick(event){
    let json = {
        "action": "changeMaster",
        "node": returnINT(event.target.id)
    }
    socket.send(JSON.stringify(json));
}

function returnINT(val){
    const regex = /\d+/gm;
    const str = val;
    let m = regex.exec(str)
    return m[0]
}
function CrashNode(node){
    if(document.getElementById(node.Node)){
        document.getElementById(B_Kill_Node + node.Node).setAttribute("disabled", true)
        document.getElementById(B_Change_Master + node.Node).setAttribute("disabled", true)
        if(document.getElementById(node.Node).parentNode.id == "MNRun")
            document.getElementById("MNDown").appendChild(document.getElementById(node.Node))
        else
            document.getElementById("SNDown").appendChild(document.getElementById(node.Node))
    }
}

function ActionCompileNode(node){
    if(!document.getElementById(node.Node))
        CreateNode(node)
    else{
        document.getElementById(node.Node + CNT).innerText = node.Processed
        document.getElementById(node.Node + VL).innerText = node.ActionValue
    }
}

function ChangeStatusNode(node){
    if(document.getElementById("MNRun").children[0]){
        document.getElementById("MNDown").appendChild(document.getElementById("MNRun").children[0])
    }
    document.getElementById("MNRun").appendChild(document.getElementById(node.Node))
    document.getElementById(B_Change_Master + node.Node).setAttribute("disabled", true)
    
}

function BecameSlave(node){
    document.getElementById("SNRun").appendChild(document.getElementById(node.Node))
    document.getElementById(B_Change_Master + node.Node).removeAttribute("disabled")
}
function InitNode(nodes){
    let Master = { "type": "Master","status": "Create","Node" : "Node_" + nodes.Master.Run }
    CreateNode(Master)
    for (let index = 0; index < nodes.Slave.Run.length; index++) {
        let Slave = { "type": "Slave","status": "Create","Node" : "Node_" + nodes.Slave.Run[index] }
        CreateNode(Slave)
    }
}

function selfCreateElement(typeElement, params){
    let el  = document.createElement(typeElement)
    if(params != undefined) {
        if (params.id)
            el.setAttribute("id", params.id)
        if (params.class)
            el.setAttribute("class", params.class)
        if (params.value) {
            if (typeElement == 'textarea')
                el.innerText = params.value
            else
                el.setAttribute("value", params.value)
        }
        if (params.type)
            el.setAttribute("type", params.type)
        if (params.style)
            el.setAttribute("style", params.style)
        if (params.type == "checkbox" && params.checked)
            el.setAttribute("checked", params.checked)
        if (params.innerHTML)
            el.innerHTML = params.innerHTML
        if (params.href)
            el.href = params.href
        if (params.innerText)
            el.innerText = params.innerText
        if (params.disabled)
            el.setAttribute("disabled", params.disabled)
        if (params.for)
            el.setAttribute("for", params.for)

        if (params.data_parent)
            el.setAttribute("data-parent", params.data_parent)
        if (params.data_parentNode)
            el.setAttribute("data-parentNode", params.data_parentNode)
        if (params.data_treeLevel)
            el.setAttribute("data-treeLevel", params.data_treeLevel)
        if (params.data_hasJob)
            el.setAttribute("data-hasJob", params.data_hasJob)

        if(params.onclick)
            el.setAttribute("onclick", params.onclick)
        if(params.onblur)
            el.setAttribute("onblur", params.onblur)
        if(params.onkeydown)
            el.setAttribute("onkeydown", params.onkeydown)
        if(params.onkeyup)
            el.setAttribute("onkeyup", params.onkeyup)

    }
    //console.log(el)
    return el
}
</script>

<style>
    .SlaveNodeRun{
        border: 1px solid green;
    }
    .MasterNodeRun{
        border: 1px solid green;
    }
    .SlaveNodeDown{
        border: 1px solid red;
    }
    .MasterNodeDown{
        border: 1px solid red;
    }
    span{
        margin: 10px;
    }
</style>